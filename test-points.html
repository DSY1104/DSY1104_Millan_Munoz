<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Points System - LevelUp</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
    <style>
      .test-container {
        max-width: 800px;
        margin: 100px auto;
        padding: 20px;
        background: rgba(26, 26, 26, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .test-button {
        margin: 5px;
        padding: 10px 15px;
        background: var(--accent-blue);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .test-button:hover {
        background: var(--accent-green);
        transform: translateY(-2px);
      }

      .status-display {
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .level-display {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-blue),
          var(--accent-green)
        );
        transition: width 0.6s ease;
        border-radius: 10px;
      }

      .purchase-form {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }

      .purchase-form input {
        padding: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ðŸŽ® Sistema de Puntos - Test</h1>

      <div class="test-section">
        <h2>Estado Actual del Usuario</h2>
        <div id="user-status" class="status-display">
          <div class="level-display">
            <span id="level-icon">ðŸ¥‰</span>
            <span id="level-name">Bronze</span>
            <span>(<span id="current-points">0</span> puntos)</span>
          </div>
          <div class="progress-bar">
            <div
              id="progress-fill"
              class="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div>
            Progreso: <span id="progress-current">0</span> /
            <span id="progress-total">1000</span> hacia
            <span id="next-level">Silver</span>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2>Simular Compras</h2>
        <div class="purchase-form">
          <input
            type="number"
            id="purchase-amount"
            placeholder="Monto (CLP)"
            value="50000"
          />
          <button class="test-button" onclick="simulatePurchase()">
            Simular Compra
          </button>
        </div>

        <div style="margin: 10px 0">
          <h3>Compras RÃ¡pidas:</h3>
          <button class="test-button" onclick="simulatePurchase(25000)">
            $25.000
          </button>
          <button class="test-button" onclick="simulatePurchase(50000)">
            $50.000
          </button>
          <button class="test-button" onclick="simulatePurchase(100000)">
            $100.000
          </button>
          <button class="test-button" onclick="simulatePurchase(200000)">
            $200.000
          </button>
        </div>
      </div>

      <div class="test-section">
        <h2>GestiÃ³n de Puntos</h2>
        <button class="test-button" onclick="addTestPoints(500)">
          +500 puntos
        </button>
        <button class="test-button" onclick="addTestPoints(1000)">
          +1000 puntos
        </button>
        <button class="test-button" onclick="setPoints(1200)">
          Set 1200 (Silver)
        </button>
        <button class="test-button" onclick="setPoints(2500)">
          Set 2500 (Gold)
        </button>
        <button class="test-button" onclick="setPoints(5000)">
          Set 5000 (Platinum)
        </button>
        <button class="test-button" onclick="resetPoints()">Reset</button>
      </div>

      <div class="test-section">
        <h2>Ãšltimas Transacciones</h2>
        <div
          id="transaction-log"
          style="max-height: 200px; overflow-y: auto"
        ></div>
      </div>

      <div class="test-section">
        <h2>NavegaciÃ³n</h2>
        <a href="pages/user/profile.html" class="test-button">Ver Perfil</a>
        <a href="pages/cart/shopping-cart.html" class="test-button"
          >Ir al Carrito</a
        >
      </div>
    </div>

    <script type="module">
      import { pointsSystem } from "./assets/js/utils/points-system.js";

      let transactionLog = [];

      // Initialize
      await pointsSystem.init();
      updateDisplay();

      // Listen for points updates
      document.addEventListener("pointsUpdated", () => {
        updateDisplay();
      });

      function updateDisplay() {
        const status = pointsSystem.getUserStatus();

        // Update level display
        document.getElementById("level-icon").textContent =
          status.currentLevel.icon;
        document.getElementById("level-name").textContent =
          status.currentLevel.name;
        document.getElementById("current-points").textContent =
          status.points.toLocaleString();

        // Update progress
        document.getElementById("progress-fill").style.width =
          status.progress.percentage + "%";
        document.getElementById("progress-current").textContent =
          status.progress.currentLevelPoints.toLocaleString();

        if (status.progress.isMaxLevel) {
          document.getElementById("progress-total").textContent = "MAX";
          document.getElementById("next-level").textContent = "Nivel MÃ¡ximo";
        } else {
          document.getElementById("progress-total").textContent =
            status.progress.totalPointsNeeded.toLocaleString();
          document.getElementById("next-level").textContent =
            status.nextLevel.name;
        }
      }

      function updateTransactionLog() {
        const logElement = document.getElementById("transaction-log");
        const recentTransactions = transactionLog.slice(-5).reverse();

        logElement.innerHTML = recentTransactions
          .map(
            (transaction) =>
              `<div style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    ${transaction}
                </div>`
          )
          .join("");
      }

      // Global functions for button clicks
      window.simulatePurchase = async function (amount) {
        const purchaseAmount =
          amount ||
          parseInt(document.getElementById("purchase-amount").value) ||
          0;

        if (purchaseAmount <= 0) {
          alert("Por favor ingresa un monto vÃ¡lido");
          return;
        }

        const result = pointsSystem.processPurchase(purchaseAmount, []);

        transactionLog.push(
          `ðŸ’³ Compra $${purchaseAmount.toLocaleString()} â†’ +${
            result.pointsEarned
          } puntos ${result.leveledUp ? "ðŸŽ‰ Â¡Nivel aumentado!" : ""}`
        );

        updateTransactionLog();

        if (result.leveledUp) {
          alert(
            `ðŸŽ‰ Â¡Felicitaciones! Has alcanzado el nivel ${result.newLevel.name}!`
          );
        }
      };

      window.addTestPoints = function (points) {
        const oldLevel = pointsSystem.getCurrentLevel();
        pointsSystem.addPoints(points);
        const newLevel = pointsSystem.getCurrentLevel();

        transactionLog.push(`âž• +${points} puntos agregados`);
        updateTransactionLog();

        if (oldLevel.name !== newLevel.name) {
          alert(`ðŸŽ‰ Â¡Nivel aumentado a ${newLevel.name}!`);
        }
      };

      window.setPoints = function (points) {
        const oldLevel = pointsSystem.getCurrentLevel();
        pointsSystem.setPointsForTesting(points);
        const newLevel = pointsSystem.getCurrentLevel();

        transactionLog.push(`ðŸ”§ Puntos establecidos a ${points}`);
        updateTransactionLog();

        if (oldLevel.name !== newLevel.name) {
          alert(`ðŸŽ‰ Â¡Nivel cambiado a ${newLevel.name}!`);
        }
      };

      window.resetPoints = function () {
        pointsSystem.resetPoints();
        transactionLog.push(`ðŸ”„ Puntos reiniciados`);
        updateTransactionLog();
      };
    </script>
  </body>
</html>
